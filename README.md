# HotelSearchApp
[![Java](https://img.shields.io/badge/Java-007396?style=flat&logo=java&logoColor=white)](https://www.java.com/)
[![Spring Boot](https://img.shields.io/badge/Spring_Boot-6DB33F?style=flat&logo=spring-boot&logoColor=white)](https://spring.io/projects/spring-boot)
[![Swagger](https://img.shields.io/badge/Swagger-85EA2D?style=flat&logo=swagger&logoColor=white)](https://swagger.io/)
[![Mockito](https://img.shields.io/badge/Mockito-5D2F70?style=flat&logo=Mockito&logoColor=white)](https://site.mockito.org/)
[![PostgreSQL](https://img.shields.io/badge/PostgreSQL-336791?style=flat&logo=postgresql&logoColor=white)](https://www.postgresql.org/)
[![Postman](https://img.shields.io/badge/Postman-FF6C37?style=flat&logo=postman&logoColor=white)](https://www.postman.com/)
[![Kafka](https://img.shields.io/badge/Kafka-231F20?style=flat&logo=apache-kafka&logoColor=white)](https://kafka.apache.org/)

**HotelSearchApp** es una aplicación desarrollada con **Spring Boot** que permite realizar búsquedas de hoteles y gestionar eventos relacionados con la disponibilidad de los mismos. La aplicación proporciona dos endpoints REST para interactuar con la búsqueda de hoteles y la consulta de búsquedas similares.

La aplicación también utiliza **Kafka** para manejar eventos de disponibilidad de hoteles y se integra con **PostgreSQL** para almacenar los datos de búsqueda.

## Objetivo

- Desarrollo de una aplicación con **Spring Boot**.
- La aplicación debe proveer de dos llamadas **REST**:
    - **POST** `/search`:
        - Estructura del cuerpo de la petición:
      ```json
      {
        "hotelId": "1234aBc",
        "checkIn": "29/12/2023",
        "checkOut": "31/12/2023",
        "ages": [30, 29, 1, 3]
      }
      ```
        - Respuesta de la petición:
      ```json
      {
        "searchId": "xxxxx"
      }
      ```
    - **GET** `/count`:
        - Parámetro: `searchId` (valor devuelto por la petición **POST /search**).
        - Respuesta:
      ```json
      {
        "searchId": "xxxxx",
        "search": {
          "hotelId": "1234aBc",
          "checkIn": "29/12/2023",
          "checkOut": "31/12/2023",
          "ages": [3, 29, 30, 1]
        },
        "count": 100
      }
      ```
- La llamada a **/search** debe realizar las siguientes acciones:
    - Validar el payload recibido.
    - El payload debe ser recibido en un objeto **inmutable**.
    - Enviar el payload al **topic de Kafka** `hotel_availability_searches`.
    - Agregar un consumidor de Kafka que persista los mensajes en la base de datos (PostgreSQL o MongoDB).

## Tecnologías Usadas

- **Java** (versión 17 o superior)
- **Spring Boot**
- **Kafka** (para gestión de eventos y comunicación asíncrona)
- **PostgreSQL** (como sistema de base de datos)
- **JUnit** (para pruebas unitarias)
- **Mockito** (para pruebas de integración y unitarias)
- **Maven** (para la gestión de dependencias y construcción del proyecto)

## Cómo Funciona la Aplicación

## Tabla de Contenidos
- [Instalación](#instalación)
- [Ejecutar la Aplicación](#ejecutar-la-aplicación)
- [Tecnologías Usadas](#tecnologías-usadas)
- [Licencia](#licencia)

## Instalación

### Clonar el repositorio
```bash
git clone https://github.com/tuusuario/HotelSearchApp.git
cd HotelSearchApp
```

### Instalación de Kafka

1. **Descargar Kafka**:
   Ve a [Kafka Downloads](https://kafka.apache.org/downloads) y descarga la versión estable de Kafka.

2. **Instalar Kafka**:
   Una vez descargado, extrae el archivo y ubícalo en una carpeta en tu máquina.

3. **Inicializar Zookeeper**:
   Kafka depende de Zookeeper, por lo que primero debes iniciar Zookeeper:
   ```bash
   .\zookeeper-server-start.bat ..\..\config\zookeeper.properties
   .\kafka-server-start.bat ..\..\config\server.properties
   ```
## Crear la Base de Datos y Tabla en PostgreSQL

### 1. Crear la Base de Datos

Primero, debes crear la base de datos en **PostgreSQL**. Si aún no tienes PostgreSQL instalado, descárgalo desde [PostgreSQL Downloads](https://www.postgresql.org/download/).

Para crear la base de datos, sigue estos pasos:

1. Abre **pgAdmin** o usa la terminal de PostgreSQL.
2. Ejecuta el siguiente comando SQL para crear la base de datos llamada `hotelsearchdb`:

   ```sql
   CREATE DATABASE hotelsearchdb;
   
   CREATE TABLE public.hotel_search (
    search_id varchar(255) NOT NULL,
    hotel_id varchar(255) NOT NULL,
    check_in timestamp NOT NULL,
    check_out timestamp NOT NULL,
    ages _int4 NOT NULL,
    id int8 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 9223372036854775807 START 1 CACHE 1 NO CYCLE) NOT NULL,
    CONSTRAINT hotel_search_pkey PRIMARY KEY (search_id)
    );
   
   INSERT INTO public.hotel_search (search_id, hotel_id, check_in, check_out, ages)
   VALUES
   ('1234abcd', '1234aBc', '2023-12-29 12:00:00', '2023-12-31 12:00:00', '{30, 29, 1, 3}');

   SELECT * FROM public.hotel_search;

## Comandos de Maven para el Proyecto

Para gestionar el ciclo de vida de la aplicación con Maven, puedes usar los siguientes comandos desde la terminal.

### 1. Limpiar el Proyecto (`mvn clean`)

El comando `mvn clean` elimina todos los archivos generados durante la compilación anterior, asegurando que la próxima compilación comience desde cero. Esto puede ser útil cuando quieres limpiar el directorio de trabajo y preparar el proyecto para una nueva compilación.

Ejecuta el siguiente comando:

```bash
    mvn clean
    mvn install
    mvn test
    mvn spring-boot:run
```
## Pruebas con Postman y cURL

### Pruebas con Postman

**Postman** es una herramienta popular para realizar pruebas de API RESTful. Aquí te explico cómo realizar las pruebas con Postman para las dos rutas proporcionadas (`/search` y `/count`).

#### 1. **Prueba de la API POST: `/search`**

Esta llamada se utiliza para crear una nueva búsqueda de hotel. La solicitud debe ser un **POST** con un cuerpo JSON que contiene los detalles de la búsqueda.

##### Paso a paso:

1. Abre **Postman**.
2. Selecciona el método **POST**.
3. Ingresa la siguiente URL: `http://localhost:8081/api/search`.
4. En la pestaña **Body**, selecciona **raw** y asegúrate de que el tipo sea **JSON**.
5. Agrega el siguiente JSON en el cuerpo de la solicitud:

```json
{
  "hotelId": "1234aBc",
  "checkIn": "29/12/2023",
  "checkOut": "31/12/2023",
  "ages": [30, 29, 1, 3]
}

Response:
{
  "searchId": "xxxxx"
}
```
## Pruebas con Postman

### 2. Prueba de la API GET: `/count`

Esta llamada se utiliza para obtener el número de búsquedas similares a una búsqueda previamente registrada, utilizando el `searchId` de la respuesta de la llamada anterior.

#### Paso a paso:

1. Abre **Postman**.
2. Selecciona el método **GET**.
3. Ingresa la siguiente URL (reemplaza `xxxxx` con el `searchId` que recibiste del paso anterior):  
   `http://localhost:8081/api/count?searchId=xxxxx`.
4. Haz clic en **Send**.

#### Respuesta esperada:

```json
{
  "searchId": "xxxxx",
  "search": {
    "hotelId": "1234aBc",
    "checkIn": "29/12/2023",
    "checkOut": "31/12/2023",
    "ages": [30, 29, 1, 3]
  },
  "count": 100
}
```
#### cURL's:
```
curl -X POST http://localhost:8081/search \
-H "Content-Type: application/json" \
-d '{
"hotelId": "1234aBc",
"checkIn": "29/12/2023",
"checkOut": "31/12/2023",
"ages": [30, 29, 1, 3]
}'


curl -X GET "http://localhost:8081/count?searchId=xxxxx"

````



## Licencia: 

MIT.
